import React, { useState, useEffect } from 'react';
import { Pickaxe, Zap, TrendingUp, Clock } from 'lucide-react';

const MonadOreMiner = () => {
  const [account, setAccount] = useState('');
  const [balance, setBalance] = useState('0');
  const [unclaimed, setUnclaimed] = useState('0');
  const [mining, setMining] = useState(false);
  const [hashRate, setHashRate] = useState(0);
  const [difficulty, setDifficulty] = useState(0);
  const [totalSupply, setTotalSupply] = useState('0');
  const [connected, setConnected] = useState(false);
  const [nextMineTime, setNextMineTime] = useState(0);
  const [particles, setParticles] = useState([]);

  const RPC_URL = 'https://testnet-rpc.monad.xyz';
  const CONTRACT_ADDRESS = '0x7Aa87dFeFC4E07EdB718bb0f7e0F18103ab3d415';

  const CONTRACT_ABI = [
    "function mine(uint256 nonce) external",
    "function claimRewards() external",
    "function balanceOf(address account) view returns (uint256)",
    "function unclaimedRewards(address account) view returns (uint256)",
    "function difficulty() view returns (uint256)",
    "function totalSupply() view returns (uint256)",
    "function getMinerInfo(address miner) view returns (uint256, uint256, uint256, uint256)",
    "function getStats() view returns (uint256, uint256, uint256, uint256)"
  ];

  useEffect(() => {
    checkConnection();
    const interval = setInterval(() => {
      if (connected) updateStats();
    }, 3000);
    return () => clearInterval(interval);
  }, [connected]);

  useEffect(() => {
    const particleInterval = setInterval(() => {
      if (mining) {
        setParticles(prev => [...prev, {
          id: Date.now(),
          x: Math.random() * 100,
          y: Math.random() * 100
        }]);
        setTimeout(() => {
          setParticles(prev => prev.slice(1));
        }, 2000);
      }
    }, 200);
    return () => clearInterval(particleInterval);
  }, [mining]);

  const checkConnection = async () => {
    if (typeof window.ethereum !== 'undefined') {
      try {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length > 0) {
          setAccount(accounts[0]);
          setConnected(true);
          await updateStats();
        }
      } catch (error) {
        console.error('Connection check failed:', error);
      }
    }
  };

  const connectWallet = async () => {
    if (typeof window.ethereum === 'undefined') {
      alert('MetaMask not detected. Please install MetaMask extension.');
      return;
    }

    try {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      setAccount(accounts[0]);

      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x29A' }],
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: '0x29A',
              chainName: 'Monad Testnet',
              nativeCurrency: {
                name: 'Monad',
                symbol: 'MON',
                decimals: 18
              },
              rpcUrls: [RPC_URL],
              blockExplorerUrls: ['https://explorer.testnet.monad.xyz/']
            }]
          });
        }
      }

      setConnected(true);
      await updateStats();
    } catch (error) {
      console.error('Wallet connection failed:', error);
    }
  };

  const updateStats = async () => {
    if (!window.ethers || !connected) return;

    try {
      const provider = new window.ethers.BrowserProvider(window.ethereum);
      const contract = new window.ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

      const [bal, unc, lastMine, nextMine] = await contract.getMinerInfo(account);
      const [supply, diff] = await contract.getStats();

      setBalance(window.ethers.formatEther(bal));
      setUnclaimed(window.ethers.formatEther(unc));
      setDifficulty(Number(diff));
      setTotalSupply(window.ethers.formatEther(supply));
      
      const now = Math.floor(Date.now() / 1000);
      setNextMineTime(Number(nextMine) > now ? Number(nextMine) - now : 0);
    } catch (error) {
      console.error('Stats update failed:', error);
    }
  };

  const startMining = async () => {
    if (!connected) {
      alert('Connect wallet first');
      return;
    }

    if (nextMineTime > 0) {
      alert(`Wait ${nextMineTime} seconds before next mine`);
      return;
    }

    setMining(true);
    
    try {
      const provider = new window.ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      const contract = new window.ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      let nonce = Math.floor(Math.random() * 1000000000);
      let attempts = 0;
      const maxAttempts = 100000;

      const mineInterval = setInterval(() => {
        setHashRate(prev => prev + Math.floor(Math.random() * 5000));
      }, 100);

      while (attempts < maxAttempts) {
        attempts++;
        
        const hash = window.ethers.solidityPackedKeccak256(
          ['address', 'uint256', 'uint256', 'uint256'],
          [account, nonce, Math.floor(Date.now() / 1000), Math.floor(Math.random() * 1000000)]
        );

        const target = BigInt(2) ** BigInt(256 - difficulty);
        if (BigInt(hash) < target) {
          clearInterval(mineInterval);
          
          const tx = await contract.mine(nonce);
          await tx.wait();
          
          alert('Mining successful! Rewards added to unclaimed balance.');
          await updateStats();
          setMining(false);
          setHashRate(0);
          return;
        }
        
        nonce++;
      }

      clearInterval(mineInterval);
      alert('No valid hash found. Try again.');
      setMining(false);
      setHashRate(0);
    } catch (error) {
      console.error('Mining failed:', error);
      alert('Mining failed: ' + (error.reason || error.message));
      setMining(false);
      setHashRate(0);
    }
  };

  const claimRewards = async () => {
    if (!connected || parseFloat(unclaimed) === 0) return;

    try {
      const provider = new window.ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      const contract = new window.ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      const tx = await contract.claimRewards();
      await tx.wait();
      
      alert('Rewards claimed successfully!');
      await updateStats();
    } catch (error) {
      console.error('Claim failed:', error);
      alert('Claim failed: ' + (error.reason || error.message));
    }
  };

  return (
    <div className="min-h-screen bg-black text-white overflow-hidden relative">
      <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
      
      {/* Animated background */}
      <div className="fixed inset-0 opacity-30">
        <div className="absolute top-0 left-1/4 w-96 h-96 bg-purple-600 rounded-full filter blur-3xl animate-pulse"></div>
        <div className="absolute bottom-0 right-1/4 w-96 h-96 bg-blue-600 rounded-full filter blur-3xl animate-pulse" style={{animationDelay: '1s'}}></div>
        <div className="absolute top-1/2 left-1/2 w-96 h-96 bg-pink-600 rounded-full filter blur-3xl animate-pulse" style={{animationDelay: '2s'}}></div>
      </div>

      {/* Mining particles */}
      {particles.map(p => (
        <div
          key={p.id}
          className="absolute w-2 h-2 bg-yellow-400 rounded-full animate-ping"
          style={{
            left: `${p.x}%`,
            top: `${p.y}%`,
            animationDuration: '2s'
          }}
        />
      ))}

      <div className="relative z-10 max-w-7xl mx-auto px-4 py-8">
        {/* Header */}
        <div className="text-center mb-16 mt-8">
          <div className="inline-block mb-6 relative">
            <Pickaxe className="w-20 h-20 text-yellow-400 animate-bounce" />
            <div className="absolute inset-0 blur-xl bg-yellow-400 opacity-50"></div>
          </div>
          <h1 className="text-7xl font-black mb-4 tracking-tight">
            <span className="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 bg-clip-text text-transparent">
              MONAD
            </span>
            <span className="text-white"> ORE</span>
          </h1>
          <p className="text-xl text-gray-400 font-light">proof-of-work mining on monad testnet</p>
        </div>

        {/* Stats Bar */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-12">
          <div className="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-2xl p-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-gray-400 text-sm uppercase tracking-wider">Total Supply</span>
              <TrendingUp className="w-5 h-5 text-green-400" />
            </div>
            <p className="text-3xl font-bold">{parseFloat(totalSupply).toFixed(2)}</p>
            <p className="text-xs text-gray-500 mt-1">ORE mined</p>
          </div>

          <div className="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-2xl p-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-gray-400 text-sm uppercase tracking-wider">Difficulty</span>
              <Zap className="w-5 h-5 text-yellow-400" />
            </div>
            <p className="text-3xl font-bold">{difficulty}</p>
            <p className="text-xs text-gray-500 mt-1">current level</p>
          </div>

          <div className="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-2xl p-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-gray-400 text-sm uppercase tracking-wider">Hash Rate</span>
              <Clock className="w-5 h-5 text-blue-400" />
            </div>
            <p className="text-3xl font-bold">{hashRate.toLocaleString()}</p>
            <p className="text-xs text-gray-500 mt-1">hashes/sec</p>
          </div>
        </div>

        {/* Main Content */}
        <div className="grid md:grid-cols-2 gap-8">
          {/* Left Panel */}
          <div className="space-y-6">
            {/* Wallet */}
            <div className="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-3xl p-8">
              {!connected ? (
                <div className="text-center py-12">
                  <div className="w-16 h-16 bg-gradient-to-r from-purple-600 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg className="w-8 h-8" fill="white" viewBox="0 0 24 24">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                    </svg>
                  </div>
                  <h3 className="text-2xl font-bold mb-4">Connect Wallet</h3>
                  <p className="text-gray-400 mb-8">Start mining ORE tokens on Monad</p>
                  <button
                    onClick={connectWallet}
                    className="px-8 py-4 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 rounded-xl font-semibold text-lg transition-all transform hover:scale-105"
                  >
                    Connect MetaMask
                  </button>
                </div>
              ) : (
                <div>
                  <div className="flex items-center justify-between mb-6">
                    <h3 className="text-xl font-bold">Your Wallet</h3>
                    <div className="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                  </div>
                  
                  <div className="bg-black/40 rounded-xl p-4 mb-4 border border-gray-700">
                    <p className="text-xs text-gray-500 mb-1">ADDRESS</p>
                    <p className="font-mono text-sm">{account.slice(0, 6)}...{account.slice(-4)}</p>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-black/40 rounded-xl p-4 border border-gray-700">
                      <p className="text-xs text-gray-500 mb-1">BALANCE</p>
                      <p className="text-2xl font-bold text-green-400">{parseFloat(balance).toFixed(4)}</p>
                      <p className="text-xs text-gray-500">ORE</p>
                    </div>
                    <div className="bg-black/40 rounded-xl p-4 border border-gray-700">
                      <p className="text-xs text-gray-500 mb-1">UNCLAIMED</p>
                      <p className="text-2xl font-bold text-yellow-400">{parseFloat(unclaimed).toFixed(4)}</p>
                      <p className="text-xs text-gray-500">ORE</p>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Claim */}
            {connected && (
              <div className="bg-gradient-to-br from-yellow-900/20 to-orange-900/20 border border-yellow-700/50 rounded-3xl p-8">
                <h3 className="text-xl font-bold mb-4">Claim Rewards</h3>
                <p className="text-gray-400 text-sm mb-6">Transfer unclaimed rewards to your balance</p>
                <button
                  onClick={claimRewards}
                  disabled={parseFloat(unclaimed) === 0}
                  className={`w-full py-4 rounded-xl font-semibold text-lg transition-all ${
                    parseFloat(unclaimed) > 0
                      ? 'bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700 transform hover:scale-105'
                      : 'bg-gray-800 text-gray-600 cursor-not-allowed'
                  }`}
                >
                  Claim {parseFloat(unclaimed).toFixed(4)} ORE
                </button>
              </div>
            )}
          </div>

          {/* Right Panel - Mining */}
          <div className="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-3xl p-8">
            <h3 className="text-2xl font-bold mb-6">Mining Control</h3>
            
            {mining ? (
              <div className="space-y-6">
                <div className="bg-green-500/10 border border-green-500/50 rounded-xl p-6 text-center">
                  <Pickaxe className="w-12 h-12 mx-auto mb-4 text-green-400 animate-bounce" />
                  <p className="text-lg font-semibold text-green-400 mb-2">Mining Active</p>
                  <p className="text-sm text-gray-400">Searching for valid proof-of-work...</p>
                </div>
                
                <div className="space-y-3">
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-400">Progress</span>
                    <span className="text-white font-semibold">{(hashRate / 1000).toFixed(1)}k hashes</span>
                  </div>
                  <div className="w-full bg-gray-800 rounded-full h-2 overflow-hidden">
                    <div className="h-full bg-gradient-to-r from-green-500 to-blue-500 animate-pulse" style={{width: '100%'}}></div>
                  </div>
                </div>

                <button
                  onClick={() => setMining(false)}
                  className="w-full py-4 bg-red-600 hover:bg-red-700 rounded-xl font-semibold text-lg transition-all"
                >
                  Stop Mining
                </button>
              </div>
            ) : (
              <div className="space-y-6">
                <div className="bg-black/40 rounded-xl p-6 border border-gray-700">
                  <p className="text-sm text-gray-400 mb-4">Mining generates ORE tokens through proof-of-work. Find a valid hash to earn rewards.</p>
                  
                  {nextMineTime > 0 && (
                    <div className="bg-orange-500/10 border border-orange-500/50 rounded-lg p-3 mb-4">
                      <p className="text-sm text-orange-400">‚è± Cooldown: {nextMineTime}s remaining</p>
                    </div>
                  )}

                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span className="text-gray-500">Reward per block:</span>
                      <span className="text-white font-semibold">1.00 ORE</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500">Min interval:</span>
                      <span className="text-white font-semibold">10 seconds</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500">Max supply:</span>
                      <span className="text-white font-semibold">21M ORE</span>
                    </div>
                  </div>
                </div>

                <button
                  onClick={startMining}
                  disabled={!connected || nextMineTime > 0}
                  className={`w-full py-5 rounded-xl font-bold text-xl transition-all ${
                    connected && nextMineTime === 0
                      ? 'bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 transform hover:scale-105 shadow-lg shadow-green-500/50'
                      : 'bg-gray-800 text-gray-600 cursor-not-allowed'
                  }`}
                >
                  {!connected ? 'Connect Wallet' : nextMineTime > 0 ? `Wait ${nextMineTime}s` : 'Start Mining'}
                </button>
              </div>
            )}
          </div>
        </div>

        {/* Footer */}
        <div className="mt-16 text-center">
          <div className="inline-block bg-gradient-to-r from-gray-900 to-gray-800 border border-gray-700 rounded-full px-6 py-3 mb-4">
            <a 
              href="https://x.com/ega_2ez4crypto" 
              target="_blank" 
              rel="noopener noreferrer"
              className="text-blue-400 hover:text-blue-300 font-semibold flex items-center gap-2"
            >
              <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
              @ega_2ez4crypto
            </a>
          </div>
          <p className="text-gray-500 text-sm">
            Contract: <span className="font-mono text-gray-400">{CONTRACT_ADDRESS}</span>
          </p>
        </div>
      </div>
    </div>
  );
};

export default MonadOreMiner;